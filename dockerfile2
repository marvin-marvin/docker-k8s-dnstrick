### first stage
FROM ubuntu:latest as builder

# apply updates & install git
RUN apt-get update -y && apt-get install -y git

# pass key as env variable
RUN mkdir /root/.ssh
ARG REPO_KEY
RUN echo "${REPO_KEY}" > /root/.ssh/id_rsa
RUN chmod -R 0700 /root/.ssh
#RUN ln -snf /root/.ssh/repo_key_rsa /root/.ssh/id_rsa
RUN cat /root/.ssh/id_rsa

# make sure your domain is accepted
RUN touch /root/.ssh/known_hosts
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

# clone repo
RUN git clone git@github.com:marvin-marvin/k8s-cfg.git /root/k8s-cfg

# rm keys
RUN rm -rf /root/.ssh

### second stage
FROM ubuntu:latest

# copy the actual stuff
COPY --from=builder /root/k8s-cfg/dnstrick/crontab /etc/cron.d/crontab

# use it
RUN touch /var/log/cron.log
RUN apt-get update -y && apt-get install -y curl cron git && \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
RUN /usr/bin/crontab /etc/cron.d/crontab && chmod 0644 /etc/cron.d/crontab
ENV TZ=Europe/Berlin
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
CMD ["cron", "-f"]
